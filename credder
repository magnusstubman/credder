#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#from __future__ import print_function

import sys
import argparse

parser = argparse.ArgumentParser()
parser.add_argument('dump', metavar='<output from secertsdump.py>.txt', help='Output from secretsdump.py -ntds ... -system ... LOCAL > dump.txt', type=argparse.FileType('r'))
parser.add_argument('-e', '--enabled-users', metavar='<list of enabled users>.txt', help='Used to only show enabled accounts. Maybe get this from bloodhound? MATCH (n:User) WHERE n.enabled = TRUE RETURN n', type=argparse.FileType('r'))
parser.add_argument('-c', '--cracked-hashes', metavar='<output from hashcat>.txt', help='take a hashcat --show', type=argparse.FileType('r'))
parser.add_argument('--username-only', help='only show usernames', default=False, required=False, action='store_true')
parser.add_argument('--ntlm-only', help='only show NTLM hashes', default=False, required=False, action='store_true')
parser.add_argument('--cleartext-only', help='only show cleartext', default=False, required=False, action='store_true')
parser.add_argument('--search-ntlm', metavar='<NTLM>', help='show all accounts with specified NTLM hash', required=False)
parser.add_argument('--cracked-only', help='only show cracked accounts', required=False, default=False, action='store_true')
parser.add_argument('--uncracked-only', help='only show uncracked accounts', required=False, default=False, action='store_true')
parser.add_argument('-im', '--include-machines', help='include machine accounts as well', required=False, default=False, action='store_true')
parser.add_argument('-csv', help='print comma separated', required=False, default=False, action='store_true')
parser.add_argument('--sort', help='sort output', required=False, default=False, action='store_true')
parser.add_argument('--uniq', help='omit repeated output lines', required=False, default=False, action='store_true')
args = parser.parse_args()

if (args.cracked_only or args.uncracked_only) and not args.cracked_hashes:
  print('can\'t have --cracked-only or --uncracked-only without -c!')
  sys.exit(1)

if sum([args.username_only, args.ntlm_only, args.cleartext_only]) > 1:
  print('you can only have one of these set at a time: --username-only --ntlm-only --cleartext-only')
  sys.exit(1)

if args.uncracked_only and args.cleartext_only:
  print('it makes no sense to have both --uncracked-only and --cleartext-only')
  sys.exit(1)

output = []
def pr(domain, username, ntlm, cleartext):
  if username and not args.include_machines and '$' in username:
    return

  if args.cracked_only and not cleartext:
    return

  if args.uncracked_only and cleartext:
    return

  s = [] 
  if username and not args.ntlm_only and not args.cleartext_only:
    s.append(username)
  if ntlm and not args.username_only and not args.cleartext_only:
    s.append(ntlm)
  if cleartext and not args.username_only and not args.ntlm_only:
    s.append(cleartext)

  if len(s) == 0:
    return

  delimiter = ' '
  if args.csv:
    delimiter = ','

  line = delimiter.join(s)

  if args.sort or args.uniq:
    if args.uniq and line in output:
      return
    output.append(line)
  else:
    print(line)


def parseDumpLine(line):
  if ':::' in line:
    parts = line.split(':')
    if len(parts) == 7:
      domain = None 
      username = parts[0] 
      ntlm = parts[3]
      if '\\' in parts[0]:
        subparts = parts[0].split('\\')
        domain = subparts[0]
        username = subparts[1]
      return (domain, username, ntlm)
  return None


def getCleartext(ntlm, crackedLines):

  ntlm = ntlm.lower()
		
  for line in crackedLines:
    line = line.lower().replace('\n','')
    if ntlm in line:
      parts = line.split(':')
      if len(parts) == 2:
        return parts[1]
      else:
        print('there is something wrong with your hashcat output! (3)', file=sys.stderr)
        sys.exit(3)
  return None

def readLines(f):
  if f:
    f.seek(0)
    l = f.readlines()
    l = [x.lower() for x in l]
    l = [x.replace('\n', '') for x in l]
    return l

dumpLines = readLines(args.dump)
enabledLines = readLines(args.enabled_users)
crackedLines = readLines(args.cracked_hashes)

#ntlmOnlyList = []
if args.dump:
  for line in dumpLines:
    parts = parseDumpLine(line)
    if parts:
      domain, username, ntlm = parts 

      if args.search_ntlm:
        if not ntlm == args.search_ntlm:
          continue

      if username and (not args.include_machines) and ('$' in username):
        continue

      if args.enabled_users:
        if not username in enabledLines:
          continue

      cleartext = None
      if ntlm and args.cracked_hashes:
        cleartext = getCleartext(ntlm, crackedLines)

#      if args.ntlm_only:
#        if ntlm:
#          if args.cracked_only and not cleartext:
#              continue

#          if args.uncracked_only and cleartext:
#              continue
#
#          if ntlm not in ntlmOnlyList:
#            ntlmOnlyList.append(ntlm)
#        continue

      pr(domain, username, ntlm, cleartext)

#if args.ntlm_only:
#  ntlmOnlyList.sort()
#  for ntlm in ntlmOnlyList:
#    print(ntlm)

if args.sort or args.uniq:
  if args.sort:
    output.sort()
  for line in output:
    print(line)
